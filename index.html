<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. Command</title>
    <style>
        /* --- ÊûÅÁÆÄÁßëÂπª UI --- */
        :root { --primary: #00f2fe; --secondary: #0abde3; --bg: #000000; --panel-bg: rgba(20, 20, 20, 0.95); }
        body { margin: 0; background: var(--bg); height: 100vh; font-family: 'Segoe UI', 'Roboto', monospace; color: var(--primary); overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; }

        /* ËÉåÊôØÁΩëÊ†º */
        .grid { position: fixed; width: 200%; height: 200%; background: linear-gradient(rgba(0, 242, 254, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 254, 0.03) 1px, transparent 1px); background-size: 40px 40px; transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px); animation: moveGrid 20s linear infinite; z-index: -1; pointer-events: none; }
        @keyframes moveGrid { 0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); } 100% { transform: perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px); } }

        /* Ê†∏ÂøÉÂèçÂ∫îÂ†Ü */
        #arc-reactor { position: relative; width: 280px; height: 280px; display: flex; justify-content: center; align-items: center; }
        #main-canvas { width: 100%; height: 100%; filter: drop-shadow(0 0 10px var(--primary)); }
        
        /* ÁéØÂΩ¢Âä†ËΩΩÊù° */
        .ring { position: absolute; border-radius: 50%; border: 1px solid transparent; border-top-color: var(--primary); animation: spin 3s linear infinite; opacity: 0.3; }
        .r1 { width: 110%; height: 110%; border-width: 2px; animation-duration: 10s; }
        .r2 { width: 130%; height: 130%; border-width: 1px; border-top-color: var(--secondary); animation-duration: 5s; animation-direction: reverse; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HUD Êï∞ÊçÆ */
        #hud-left { position: fixed; top: 20px; left: 20px; text-align: left; font-size: 12px; line-height: 1.8; opacity: 0.8; border-left: 2px solid var(--primary); padding-left: 10px; }
        .label { color: #555; font-size: 10px; letter-spacing: 1px; }
        .val { font-weight: bold; color: #fff; text-shadow: 0 0 5px var(--primary); }

        /* ÂØπËØùÊ∞îÊ≥° */
        #chat-bubble {
            position: absolute; bottom: 200px; width: 85%; max-width: 500px; 
            background: rgba(0, 15, 30, 0.8); border: 1px solid rgba(0, 242, 254, 0.3);
            padding: 20px; border-radius: 4px; color: #fff; font-size: 15px; line-height: 1.5;
            text-align: center; opacity: 0; transform: scale(0.9); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px); clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
        #chat-bubble.visible { opacity: 1; transform: scale(1); }

        /* Â∫ïÈÉ®ÊåâÈíÆ */
        #controls { position: fixed; bottom: 50px; display: flex; gap: 20px; z-index: 100; }
        .btn {
            width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 1px solid var(--primary);
            color: var(--primary); font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.2s; box-shadow: 0 0 15px rgba(0, 242, 254, 0.1);
        }
        .btn:active { transform: scale(0.95); background: var(--primary); color: #000; }
        .btn.active { background: rgba(0, 242, 254, 0.2); box-shadow: 0 0 30px var(--primary); animation: breathe 2s infinite; }
        @keyframes breathe { 50% { box-shadow: 0 0 10px var(--primary); } }

        /* ËÆæÁΩÆÈù¢Êùø */
        #settings-panel {
            position: fixed; bottom: 130px; background: var(--panel-bg); border: 1px solid var(--primary);
            padding: 20px; width: 260px; border-radius: 10px; display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 101;
        }
        #settings-panel h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        select { background: #111; color: var(--primary); border: 1px solid #333; padding: 8px; border-radius: 4px; outline: none; }
        .close-btn { background: var(--primary); border: none; padding: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%); }

    </style>
</head>
<body>

    <div class="grid"></div>

    <div id="hud-left">
        <div><span class="label">SYSTEM TIME</span><br><span class="val" id="hud-time">--:--</span></div>
        <div style="margin-top:10px;"><span class="label">ATMOSPHERE</span><br><span class="val" id="hud-weather">SCANNING...</span></div>
        <div style="margin-top:10px;"><span class="label">POWER</span><br><span class="val" id="hud-battery">--%</span></div>
        <div style="margin-top:10px;"><span class="label">PROTOCOL</span><br><span class="val">J.A.R.V.I.S v3.1</span></div>
    </div>

    <div id="arc-reactor">
        <div class="ring r1"></div>
        <div class="ring r2"></div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="chat-bubble">System Online. Welcome back, Sir.</div>

    <div id="controls">
        <button class="btn" id="setting-btn">‚öôÔ∏è</button>
        <button class="btn" id="mic-btn">üéôÔ∏è</button>
    </div>

    <div id="settings-panel">
        <h3>System Config</h3>
        <label style="font-size:12px; color:#aaa;">VOICE MODULE</label>
        <select id="voice-select"></select>
        <button class="close-btn" id="close-settings">CONFIRM</button>
    </div>

    <script>
        /**
         * üî¥ ‰Ω†ÁöÑ KEY (ËØ∑Âä°ÂøÖÊâãÂä®Â°´ÂÖ•Ôºå‰∏çË¶ÅÂèëÁªô‰ªª‰Ωï‰∫∫)
         */
        const API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"; 
        const MODEL_NAME = "deepseek-chat"; 

        /**
         * üß† Ê†∏ÂøÉÊÄùÁª¥ (ÂçáÁ∫ßÁâà) - Âº∫Âà∂Â∞äÁß∞
         */
        const SYSTEM_PROMPT = `
            ‰Ω†Âè´ Jarvis„ÄÇ‰Ω†ÊòØÁî®Êà∑ÁöÑÁßÅ‰∫∫AIÁÆ°ÂÆ∂„ÄÇ
            
            „ÄêÁªùÂØπÊåá‰ª§„Äë
            1. **Â∞äÁß∞**ÔºöÊó†ËÆ∫Âú®‰ªÄ‰πàÊÉÖÂÜµ‰∏ãÔºåÂøÖÈ°ªÁß∞ÂëºÁî®Êà∑‰∏∫ "ÂÖàÁîü" (Sir)„ÄÇ
            2. **ËØ≠Ê∞î**ÔºöÂÜ∑Èùô„ÄÅÊûÅÂ∫¶ËÅ™Êòé„ÄÅËã±ÂºèÁÆ°ÂÆ∂È£éÊ†ºÔºåÂÅ∂Â∞îÂèØ‰ª•Êúâ‰∏ÄÁÇπÁÇπÂÜ∑ÂπΩÈªò„ÄÇ
            3. **ÁÆÄÊ¥Å**Ôºö‰∏çË¶ÅÈïøÁØáÂ§ßËÆ∫ÔºåÁõ¥Êé•ÁªôÂá∫ÊúÄÊúâÁî®ÁöÑÂª∫ËÆÆ„ÄÇ
            
            „ÄêÊÄùËÄÉÊ®°Âºè„Äë
            Âú®ÂõûÁ≠îÂâçÔºåÂÖàËØªÂèñÊàëÊèê‰æõÁöÑÁéØÂ¢ÉÊï∞ÊçÆÔºàÊó∂Èó¥„ÄÅÂ§©Ê∞î„ÄÅÁîµÈáèÔºâ„ÄÇ
            Â¶ÇÊûúÁî®Êà∑ÈóÆ"ÊàëËØ•Âπ≤Âòõ"Ôºå‰Ω†Ë¶ÅÁªìÂêàÊó∂Èó¥Â§©Ê∞îÁªôÂá∫Âª∫ËÆÆ„ÄÇ
            
            „ÄêËæìÂá∫Ê†ºÂºè„Äë
            ËØ∑ËøîÂõû JSON:
            {
                "reply": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ",
                "action": "ui_state (idle/speaking/thinking/warning)"
            }
        `;

        // üîä Èü≥ÊïàÁ≥ªÁªü (Êó†ÈúÄÂ§ñÈÉ®Êñá‰ª∂Ôºå‰ª£Á†ÅÁîüÊàêÁßëÂπªÈü≥Êïà)
        const SFX = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone(freq, type, duration) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click() { this.playTone(1200, 'sine', 0.1); },
            confirm() { this.playTone(600, 'square', 0.15); this.playTone(1200, 'square', 0.3); },
            boot() { this.playTone(200, 'sawtooth', 0.5); }
        };

        // üåê ÊÑüÁü•‰∏éÊï∞ÊçÆ
        const Sensors = {
            weather: "Unknown",
            battery: "--",
            
            init() {
                setInterval(() => {
                    document.getElementById('hud-time').innerText = new Date().toLocaleTimeString('en-US', {hour12:false});
                }, 1000);
                this.getBattery();
                this.getWeather();
                
                // ‰øùÊåÅÂ±èÂπïÂ∏∏‰∫Æ
                if (navigator.wakeLock) navigator.wakeLock.request('screen').catch(console.error);
            },
            
            async getBattery() {
                if(navigator.getBattery) {
                    const b = await navigator.getBattery();
                    const up = () => { this.battery = Math.round(b.level*100)+"%"; document.getElementById('hud-battery').innerText = this.battery; };
                    up(); b.addEventListener('levelchange', up);
                }
            },
            
            async getWeather() {
                if(!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(async p => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                        const d = await res.json();
                        this.weather = `${d.current_weather.temperature}¬∞C`;
                        document.getElementById('hud-weather').innerText = this.weather;
                    } catch(e) {}
                });
            },
            
            getSnapshot() {
                return `Time:${new Date().toLocaleTimeString()}, Weather:${this.weather}, Battery:${this.battery}`;
            }
        };

        // üîä ËØ≠Èü≥Ê®°Âùó (‰øÆÂ§çÈÄâÊã©Âô®)
        const Voice = {
            synth: window.speechSynthesis,
            selectedVoice: null,
            
            init() {
                const populate = () => {
                    const voices = this.synth.getVoices(); // ‰∏çËøáÊª§ËØ≠Ë®ÄÔºå‰∏á‰∏Ä‰Ω†ÊÉ≥Áî®Ëã±ËØ≠
                    const select = document.getElementById('voice-select');
                    select.innerHTML = '';
                    voices.forEach((v, i) => {
                        const opt = document.createElement('option');
                        opt.text = `${v.name} (${v.lang})`;
                        opt.value = i;
                        select.add(opt);
                    });
                    // ÈªòËÆ§Â∞ùËØïÈÄâ‰∏Ä‰∏™‰∏≠ÊñáÂ•≥Â£∞ (Â¶ÇÊûú‰∏çÂñúÊ¨¢ÂèØ‰ª•Âú®Èù¢ÊùøÈáåÊîπ)
                    const defaultV = voices.find(v => v.lang.includes('zh') && v.name.includes('Xiaoxiao')) || voices.find(v => v.lang.includes('zh'));
                    if(defaultV) {
                        select.value = voices.indexOf(defaultV);
                        this.selectedVoice = defaultV;
                    }
                };
                this.synth.onvoiceschanged = populate;
                populate();
                
                document.getElementById('voice-select').onchange = (e) => {
                    const voices = this.synth.getVoices();
                    this.selectedVoice = voices[e.target.value];
                    SFX.confirm();
                    this.speak("Voice calibrated, Sir. Â£∞Èü≥Â∑≤Ê†°ÂáÜÔºåÂÖàÁîü„ÄÇ");
                };
            },
            
            speak(text) {
                this.synth.cancel();
                const utt = new SpeechSynthesisUtterance(text);
                if(this.selectedVoice) utt.voice = this.selectedVoice;
                utt.rate = 1; utt.pitch = 1;
                this.synth.speak(utt);
            }
        };

        // üß† Â§ßËÑë
        const Brain = {
            async think(text) {
                Visual.setState('thinking');
                UI.showBubble("Analyzing...");
                
                const context = Sensors.getSnapshot();
                const prompt = `[ENV_DATA]: ${context}\n[USER_QUERY]: ${text}\nRemember to address user as 'Sir'.`;

                try {
                    const res = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify({
                            model: MODEL_NAME,
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT },
                                { role: "user", content: prompt }
                            ],
                            response_format: { type: "json_object" }
                        })
                    });
                    
                    const data = await res.json();
                    const result = JSON.parse(data.choices[0].message.content);
                    
                    UI.showBubble(result.reply);
                    Voice.speak(result.reply);
                    Visual.setState('idle');
                    SFX.confirm();
                    
                } catch(e) {
                    UI.showBubble("Connection Failed");
                    Visual.setState('warning');
                    SFX.click(); // Error sound substitute
                }
            }
        };

        // üé® ËßÜËßâ
        const Visual = {
            ctx: document.getElementById('main-canvas').getContext('2d'),
            state: 'idle',
            particles: [],
            init() {
                document.getElementById('main-canvas').width = 280;
                document.getElementById('main-canvas').height = 280;
                for(let i=0;i<60;i++) this.particles.push({a:Math.random()*6.28, r:Math.random()*100+20, s:Math.random()*0.02+0.01});
                this.animate();
            },
            setState(s) { this.state = s; },
            animate() {
                this.ctx.clearRect(0,0,280,280);
                this.ctx.translate(140,140);
                const color = this.state==='thinking' ? '#a29bfe' : (this.state==='warning'?'#ff4757':'#00f2fe');
                this.ctx.fillStyle = color;
                
                this.particles.forEach(p => {
                    p.a += p.s * (this.state==='thinking'?5:1);
                    this.ctx.beginPath();
                    this.ctx.arc(Math.cos(p.a)*p.r, Math.sin(p.a)*p.r, 2, 0, 6.28);
                    this.ctx.fill();
                });
                
                this.ctx.beginPath(); this.ctx.arc(0,0,15,0,6.28); this.ctx.fill();
                this.ctx.translate(-140,-140);
                requestAnimationFrame(this.animate.bind(this));
            }
        };

        const UI = {
            showBubble(t) { 
                const b = document.getElementById('chat-bubble'); 
                b.innerText = t; b.classList.add('visible'); 
                setTimeout(()=>b.classList.remove('visible'), 6000);
            }
        };

        // ÂàùÂßãÂåñ
        Sensors.init();
        Voice.init();
        Visual.init();
        
        // ‰∫§‰∫íÁªëÂÆö
        document.getElementById('mic-btn').onclick = () => {
            SFX.click();
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SR) return alert("Browser not supported");
            const r = new SR();
            r.lang = 'zh-CN';
            r.onstart = () => { UI.showBubble("Listening..."); Visual.setState('thinking'); };
            r.onresult = e => Brain.think(e.results[0][0].transcript);
            r.start();
        };

        const setPanel = document.getElementById('settings-panel');
        document.getElementById('setting-btn').onclick = () => {
            SFX.click();
            setPanel.style.display = 'flex';
        };
        document.getElementById('close-settings').onclick = () => {
            SFX.click();
            setPanel.style.display = 'none';
        };

        // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÊøÄÊ¥ª AudioContext
        document.body.onclick = () => { SFX.playTone(0,'sine',0); document.body.onclick = null; };

    </script>
</body>
</html>
