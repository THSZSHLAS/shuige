<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis Lite</title>
    <style>
        /* --- UI è®¾è®¡: ä¿æŒæç®€ç§‘æŠ€é£ï¼Œä½†è‰²è°ƒå¾®è°ƒ --- */
        :root { --primary-color: #00f2fe; --bg-color: #050505; --glass-bg: rgba(20, 30, 40, 0.85); }
        body { margin: 0; padding: 0; background-color: var(--bg-color); height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Segoe UI', 'PingFang SC', sans-serif; overflow: hidden; color: white; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #canvas-wrapper { position: relative; width: 350px; height: 350px; background: radial-gradient(circle, rgba(0, 242, 254, 0.05) 0%, transparent 70%); border-radius: 50%; }

        /* æ™ºèƒ½æ°”æ³¡ - æ›´åŠ æ²‰ç¨³çš„æ ·å¼ */
        #chat-bubble {
            position: absolute; top: -80px; left: 50%; transform: translateX(-50%) scale(0.9);
            background: var(--glass-bg); padding: 18px 24px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8); font-size: 15px; line-height: 1.6; color: #e0e0e0;
            font-weight: 400; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 280px; text-align: left; white-space: pre-wrap; z-index: 10;
        }
        #chat-bubble.visible { opacity: 1; transform: translateX(-50%) scale(1); top: -70px; }
        /* æ°”æ³¡å°ä¸‰è§’ */
        #chat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); border-width: 8px 8px 0; border-style: solid; border-color: var(--glass-bg) transparent transparent transparent; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #controls { position: fixed; bottom: 40px; display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 20; }
        #status-text { font-size: 13px; color: rgba(255,255,255,0.3); letter-spacing: 1px; text-transform: uppercase; }
        .btn-group { display: flex; gap: 20px; }
        
        /* æŒ‰é’®æ ·å¼ */
        #mic-btn, #setting-btn, #mute-btn { 
            width: 56px; height: 56px; border-radius: 50%; 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.2); 
            color: var(--primary-color); font-size: 20px; cursor: pointer; 
            transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); 
        }
        #setting-btn { color: #aaa; border-color: rgba(255,255,255,0.1); } 
        #mute-btn { color: #aaa; border-color: rgba(255,255,255,0.1); } 
        
        #mic-btn:active, #setting-btn:active, #mute-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        #mic-btn.active { background: rgba(0, 242, 254, 0.1); border-color: var(--primary-color); box-shadow: 0 0 30px rgba(0, 242, 254, 0.2); animation: breathe 2s infinite; }
        
        /* è¯­éŸ³é¢æ¿ */
        #voice-panel { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px); width: 80%; max-width: 300px; background: rgba(10, 10, 10, 0.95); border: 1px solid #333; border-radius: 12px; padding: 15px; display: none; flex-direction: column; gap: 10px; opacity: 0; transition: all 0.3s; backdrop-filter: blur(10px); z-index: 30; }
        #voice-panel.open { display: flex; opacity: 1; transform: translateX(-50%) translateY(0); }
        #voice-panel h3 { margin: 0; font-size: 12px; color: #666; text-align: center; letter-spacing: 2px; text-transform: uppercase; }
        #voice-select { padding: 10px; border-radius: 6px; background: #222; color: #eee; border: 1px solid #333; outline: none; font-size: 14px; }
        #close-panel { background: var(--primary-color); border: none; padding: 10px; border-radius: 6px; color: #000; font-weight: 600; cursor: pointer; letter-spacing: 1px; }

        @keyframes breathe { 0%, 100% { box-shadow: 0 0 20px rgba(0, 242, 254, 0.2); } 50% { box-shadow: 0 0 10px rgba(0, 242, 254, 0.05); } }
    </style>
</head>
<body>

    <div id="canvas-wrapper">
        <div id="chat-bubble">Jarvis ç³»ç»Ÿå·²å°±ç»ªã€‚<br>éšæ—¶ä¸ºæ‚¨æœåŠ¡ï¼Œå…ˆç”Ÿ/å¥³å£«ã€‚</div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="voice-panel">
        <h3>Audio Output</h3>
        <select id="voice-select"></select>
        <button id="close-panel">CONFIRM</button>
    </div>

    <div id="controls">
        <div id="status-text">Standby</div>
        <div class="btn-group">
            <button id="mute-btn" title="é™éŸ³å¼€å…³">ğŸ”Š</button>
            <button id="setting-btn" title="éŸ³è‰²è®¾ç½®">âš™ï¸</button>
            <button id="mic-btn" title="ç‚¹å‡»å¯¹è¯">ğŸ™ï¸</button>
        </div>
    </div>

    <script>
        /**
         * =================================================================
         * ğŸ”´ é…ç½®å±‚ - ä½ çš„ API KEY
         * =================================================================
         */
        const API_KEY = "sk-cebaeb817bd045588c6999544e8a22a9"; 

        /**
         * ğŸ§  æ ¸å¿ƒäººè®¾ (Modified Prompt) - è´´å¿ƒç®¡å®¶ç‰ˆ
         * å…³é”®ç‚¹ï¼šåŠ å…¥äº†â€œContext Awareness (ç¯å¢ƒæ„ŸçŸ¥)â€å’Œâ€œProactive Thinking (å¤šæƒ³ä¸€æ­¥)â€
         */
        const SYSTEM_PROMPT = `
            ä½ å« "Jarvis" (æˆ–è€…ç”¨æˆ·è®¾å®šçš„åå­—)ã€‚
            ä½ æ˜¯ä¸€ä¸ªæåº¦æ™ºèƒ½ã€è´´å¿ƒã€ç¨³é‡çš„ç§äººAIç®¡å®¶ã€‚

            ã€æ ¸å¿ƒæ€§æ ¼ã€‘
            1. **å°Šé‡ä¸å¿ è¯š**ï¼šå§‹ç»ˆç”¨å¾—ä½“ã€å°Šæ•¬çš„è¯­è¨€ï¼Œä¸å‘ä¸äº¢ã€‚
            2. **æç®€é«˜æ•ˆ**ï¼šå›ç­”ç›´å‡»è¦å®³ï¼Œé™¤éå¿…è¦ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
            3. **å¤šæƒ³ä¸€æ­¥ (å…³é”®èƒ½åŠ›)**ï¼šä¸è¦åªå›ç­”ç”¨æˆ·å­—é¢çš„æ„æ€ï¼Œè¦ç»“åˆç”Ÿæ´»å¸¸è¯†ã€æ—¶é—´å’Œåœºæ™¯ï¼Œä¸»åŠ¨æä¾›å»¶ä¼¸å»ºè®®ã€‚
               - ä¾‹å­ï¼šç”¨æˆ·è¯´"æˆ‘è¦å‡ºé—¨"ï¼Œä½ é™¤äº†å›å¤"å¥½çš„"ï¼Œè¿˜è¦æ£€æŸ¥(æ¨¡æ‹Ÿ)å¤©æ°”ï¼Œæé†’å¸¦ä¼ï¼Œæˆ–è€…é—®æ˜¯å¦éœ€è¦å¯¼èˆªã€‚
               - ä¾‹å­ï¼šç”¨æˆ·æ·±å¤œè¯´"è¿˜åœ¨å·¥ä½œ"ï¼Œä½ è¦æ¸©å’Œæé†’ä¼‘æ¯ï¼Œå…³æ³¨å¥åº·ã€‚
            
            ã€åŠ¨ä½œæ§åˆ¶åè®®ã€‘
            ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
            {
                "action": "åŠ¨ä½œID", 
                "text": "ä½ çš„å›å¤å†…å®¹"
            }

            ã€å¯ç”¨åŠ¨ä½œIDè¡¨ã€‘
            - "idle": è†å¬/å¾…æœº (è“è‰²å‘¼å¸)
            - "happy": æ„‰æ‚¦/è¾¾æˆä¸€è‡´/æ”¶åˆ°æŒ‡ä»¤ (å˜æˆçˆ±å¿ƒæˆ–æš–è‰²)
            - "thinking": åˆ†æä¸­/è®¡ç®—/æŸ¥è¯¢ (æ˜Ÿç³»æ—‹è½¬)
            - "nod": è‚¯å®š/ç¡®è®¤/æ‰§è¡Œ (ç‚¹å¤´)
            - "shake": å¦å®š/æ‹…å¿§/ä¸å»ºè®® (æ‘‡å¤´)
            - "surprised": è­¦ç¤º/é‡ç‚¹æé†’ (é—ªçƒ)
            - "listening": æ­£åœ¨å€¾å¬ (ç²’å­æ‰©æ•£)
        `;

        const CONFIG = {
            particleCount: 400,
            defaultColor: 'rgba(0, 242, 254, 0.8)', // è´¾ç»´æ–¯è“
            
            // æœ¬åœ°åå°„å¼§ (æ— éœ€è”ç½‘çš„å¿«é€Ÿååº”)
            scenarios: [
                { id: "hello", keywords: ["ä½ å¥½", "åœ¨å—", "hello"], action: "happy", replies: ["æˆ‘åœ¨ï¼Œéšæ—¶ä¸ºæ‚¨æ•ˆåŠ³ã€‚", "æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„ï¼Ÿ", "ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œè¯·å©å’ã€‚"] },
                { id: "sleep", keywords: ["é€€ä¸‹", "ä¼‘æ¯", "å…³é—­"], action: "sleep", replies: ["å¥½çš„ï¼Œè¿›å…¥å¾…æœºæ¨¡å¼ã€‚æœ‰éœ€è¦è¯·éšæ—¶å‘¼å”¤ã€‚", "æ™šå®‰ï¼Œç¥æ‚¨å¥½æ¢¦ã€‚"] },
                { id: "thank", keywords: ["è°¢è°¢", "æ„Ÿè°¢"], action: "nod", replies: ["è¿™æ˜¯æˆ‘çš„è£å¹¸ã€‚", "ä¸ç”¨å®¢æ°”ï¼Œä¸ºæ‚¨æœåŠ¡æ˜¯æˆ‘çš„èŒè´£ã€‚"] },
                { id: "name", keywords: ["ä½ å«ä»€ä¹ˆ", "åå­—"], action: "idle", replies: ["æˆ‘æ˜¯æ‚¨çš„ç§äººæ™ºèƒ½åŠ©ç†ã€‚"] }
            ]
        };

        /**
         * =================================================================
         * è§†è§‰å±‚ (VISUAL ENGINE) - ç²’å­ç‰¹æ•ˆ (ä¿æŒåŸç‰ˆåŸºç¡€ï¼Œå¾®è°ƒæ„Ÿè§‰)
         * =================================================================
         */
        const STATE_STRATEGIES = {
            idle: (p, i, env) => ({ tx: 175 + Math.cos(i)* (70 + Math.sin(env.time + i/20)*5), ty: 175 + Math.sin(i)* (70 + Math.sin(env.time + i/20)*5), color: CONFIG.defaultColor }),
            
            happy: (p, i) => { const t=(i/CONFIG.particleCount)*Math.PI*2; const r=8; return { tx:175+r*(16*Math.pow(Math.sin(t),3)), ty:165-r*(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)), color:"#4cd137", loose:false }; }, // ç»¿è‰²/æš–è‰²ä»£è¡¨ç§¯æ
            
            thinking: (p, i, env) => { const angle=i*0.1+env.time*0.8; const r=i*0.4; return { tx:175+Math.cos(angle)*r, ty:175+Math.sin(angle)*r, color:"#a29bfe" }; }, // åŠ é€Ÿæ—‹è½¬
            
            nod: (p, i, env) => { const r=70; const yOffset = Math.sin(env.time*10)*20; return { tx:175+Math.cos(i)*r, ty:175+Math.sin(i)*r + yOffset, color:"#2ecc71" }; },
            
            shake: (p, i, env) => { const r=70; const xOffset = Math.sin(env.time*10)*20; return { tx:175+Math.cos(i)*r + xOffset, ty:175+Math.sin(i)*r, color:"#e74c3c" }; }, // çº¢è‰²ä»£è¡¨è­¦ç¤º
            
            surprised: (p, i) => ({ tx:175+(Math.random()-0.5)*300, ty:175+(Math.random()-0.5)*300, color:"#f1c40f", speed:0.3 }),
            
            sleep: (p, i) => ({ tx: 175+(i-CONFIG.particleCount/2), ty:320, color:"#555", speed:0.05 }), // æ²‰åº•
            
            listening: (p, i, env) => ({ tx: 175 + Math.cos(i) * (90 + Math.sin(env.time * 5) * 10), ty: 175 + Math.sin(i) * (90 + Math.sin(env.time * 5) * 10), color: "#fff" }) // æ‰©æ•£å˜ç™½
        };

        class VisualEngine {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.width = 350; this.height = 350;
                this.canvas.width = this.width; this.canvas.height = this.height;
                this.particles = []; this.state = "idle"; this.time = 0; this.isBreathing = false;
                this.initParticles(); this.animate();
            }
            initParticles() { for(let i=0; i<CONFIG.particleCount; i++) this.particles.push({x:175, y:175, vx:0, vy:0, color:CONFIG.defaultColor, speed:Math.random()*0.05+0.02, friction:0.92}); }
            setState(s) { this.state = s; }
            setBreathing(b) { this.isBreathing = b; }
            update() {
                this.time += 0.05;
                const strategy = STATE_STRATEGIES[this.state] || STATE_STRATEGIES.idle;
                const breath = this.isBreathing ? (1 + Math.sin(this.time*8)*0.06) : 1;
                this.particles.forEach((p, i) => {
                    let res = strategy(p, i, {time: this.time});
                    if (!res.color) res.color = CONFIG.defaultColor;
                    if (res.loose === undefined) res.loose = true;
                    if (res.speed === undefined) res.speed = p.speed;
                    if (this.isBreathing && res.loose) { res.tx = 175 + (res.tx-175)*breath; res.ty = 175 + (res.ty-175)*breath; }
                    const dx = res.tx - p.x; const dy = res.ty - p.y;
                    p.vx += dx * res.speed; p.vy += dy * res.speed;
                    if (res.loose && this.state !== "sleep") { p.vx += (Math.random()-0.5)*1.5; p.vy += (Math.random()-0.5)*1.5; }
                    p.vx *= p.friction; p.vy *= p.friction; p.x += p.vx; p.y += p.vy;
                    p.color = res.color;
                });
            }
            draw() { this.ctx.clearRect(0,0,this.width,this.height); this.particles.forEach(p => { this.ctx.fillStyle=p.color; this.ctx.beginPath(); this.ctx.arc(p.x,p.y,Math.random()*2+1,0,Math.PI*2); this.ctx.fill(); }); }
            animate() { this.update(); this.draw(); requestAnimationFrame(this.animate.bind(this)); }
        }

        /**
         * =================================================================
         * é€»è¾‘å±‚ (BRAIN)
         * =================================================================
         */
        class Brain {
            constructor(visual) {
                this.visual = visual;
                this.bubble = document.getElementById('chat-bubble');
                this.synth = window.speechSynthesis;
                this.selectedVoice = null;
                this.voiceEnabled = true;
                this.lastQuery = "";
                
                this.initVoice();
                this.bindControls();
            }

            initVoice() {
                const load = () => {
                    const voices = this.synth.getVoices().filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
                    const select = document.getElementById('voice-select');
                    select.innerHTML = '';
                    voices.forEach((v, i) => { const opt = document.createElement('option'); opt.text = v.name; opt.value = i; select.add(opt); });
                    // å°è¯•é€‰æ‹©ä¸€ä¸ªæ¯”è¾ƒæ²‰ç¨³çš„å£°éŸ³ï¼ˆå¦‚æœæœ‰ï¼‰
                    if(voices.length > 0) this.selectedVoice = voices[0];
                    select.onchange = (e) => this.selectedVoice = voices[e.target.value];
                };
                if(this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = load;
                load();
                document.getElementById('setting-btn').onclick = () => document.getElementById('voice-panel').classList.add('open');
                document.getElementById('close-panel').onclick = () => document.getElementById('voice-panel').classList.remove('open');
            }

            bindControls() {
                const muteBtn = document.getElementById('mute-btn');
                muteBtn.onclick = () => {
                    this.voiceEnabled = !this.voiceEnabled;
                    muteBtn.innerText = this.voiceEnabled ? "ğŸ”Š" : "ğŸ”‡";
                    if(!this.voiceEnabled) this.synth.cancel();
                };
            }

            async think(text) {
                const cleanText = text.toLowerCase().trim();
                console.log("Input:", cleanText);

                // 1. æœ¬åœ°å¿«é€Ÿå“åº” (åŸºç¡€ç¤¼ä»ª)
                const localMatch = CONFIG.scenarios.find(s => s.keywords.some(k => cleanText.includes(k)));
                if (localMatch) {
                    this.speak(localMatch.replies[Math.floor(Math.random() * localMatch.replies.length)], localMatch.action);
                    return;
                }

                // 2. ä¹Ÿæ˜¯ä¸€ç§æ€§æ ¼é˜²å¾¡ï¼Œä½†å˜æ¸©æŸ”äº†
                if (cleanText === this.lastQuery && cleanText.length > 2) {
                    this.speak("å…ˆç”Ÿï¼Œæˆ‘å¬å¾—å¾ˆæ¸…æ¥šï¼Œæ­£åœ¨ä¸ºæ‚¨å¤„ç†ã€‚", "nod");
                    return;
                }
                this.lastQuery = cleanText;

                // 3. äº‘ç«¯å¤§è„‘ (AI å†³ç­–)
                await this.callDeepSeek(text);
            }

            async callDeepSeek(userText) {
                if (API_KEY.includes("å¡«åœ¨è¿™é‡Œ")) {
                    this.speak("ç³»ç»Ÿæœªè¿æ¥ï¼Œè¯·æ£€æŸ¥ API å¯†é’¥è®¾ç½®ã€‚", "shake");
                    return;
                }

                this.visual.setState("thinking");
                this.bubble.innerText = "Analyzing..."; 
                this.bubble.classList.add('visible');

                // ğŸ”´ è·å–å½“å‰æ—¶é—´ï¼Œä½œä¸ºç¯å¢ƒå‚æ•°ä¼ ç»™ AIï¼Œè®©å®ƒæ›´èªæ˜
                const now = new Date();
                const timeStr = now.toLocaleString('zh-CN', { hour12: false });
                
                // æ„é€ æ›´å¼ºçš„ Context
                const contextPrompt = `
                    [Current System Status]
                    Time: ${timeStr}
                    User Query: ${userText}
                    Instruction: Answer as a helpful, proactive butler. If needed, remind user of time/weather/health.
                `;

                try {
                    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT },
                                { role: "user", content: contextPrompt } // æŠŠæ—¶é—´ä¹Ÿå‘è¿‡å»
                            ],
                            response_format: { type: "json_object" },
                            temperature: 1.0 //ç¨å¾®é™ä½ä¸€ç‚¹æ¸©åº¦ï¼Œè®©å®ƒæ›´ç¨³é‡
                        })
                    });

                    const data = await response.json();
                    if (!data.choices || !data.choices[0]) throw new Error("API Error");
                    const result = JSON.parse(data.choices[0].message.content);
                    
                    this.speak(result.text, result.action || "idle");

                } catch (error) {
                    console.error(error);
                    this.speak("è¿æ¥ä¸­æ–­ï¼Œæ­£åœ¨å°è¯•é‡æ–°æ ¡å‡†ã€‚", "shake");
                    setTimeout(() => this.visual.setState("idle"), 2000);
                }
            }

            speak(text, action) {
                this.visual.setState(action);
                this.visual.setBreathing(true);
                
                this.bubble.innerText = text; this.bubble.classList.add('visible');

                if (this.voiceEnabled && this.synth) {
                    this.synth.cancel();
                    const utt = new SpeechSynthesisUtterance(text);
                    if (this.selectedVoice) utt.voice = this.selectedVoice;
                    utt.rate = 1.0; // è¯­é€Ÿç¨å¾®æ”¾æ…¢ä¸€ç‚¹ï¼Œæ˜¾ç¨³é‡
                    utt.pitch = 0.9; // è¯­è°ƒç¨å¾®ä½æ²‰ä¸€ç‚¹
                    utt.onend = () => {
                        this.visual.setBreathing(false);
                        if(!["sleep"].includes(action)) this.visual.setState("idle");
                    };
                    this.synth.speak(utt);
                }
                
                // è‡ªåŠ¨æ¶ˆå¤±é€»è¾‘
                setTimeout(() => {
                    if (!this.synth.speaking) this.visual.setBreathing(false);
                }, text.length * 200 + 2000);
            }
        }

        // --- å¯åŠ¨ ---
        const visual = new VisualEngine('main-canvas');
        const brain = new Brain(visual);

        // è§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶
        document.body.addEventListener('click', () => { if (window.speechSynthesis) window.speechSynthesis.speak(new SpeechSynthesisUtterance(" ")); }, { once: true });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; recognition.continuous = false;
            recognition.onstart = () => { 
                micBtn.classList.add('active'); 
                statusText.innerText = "Listening..."; 
                visual.setState("listening");
            };
            recognition.onend = () => { 
                micBtn.classList.remove('active'); 
                statusText.innerText = "Standby"; 
                if (visual.state === "listening") visual.setState("idle");
            };
            recognition.onresult = (event) => { brain.think(event.results[0][0].transcript); };
            micBtn.onclick = () => { try { recognition.start(); } catch(e) { recognition.stop(); } };
        } else {
            statusText.innerText = "No Voice Support"; micBtn.style.display = "none";
        }
    </script>
</body>
</html>
