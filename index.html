<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è“å±±äººAPI</title>
    <style>
        /* --- UI ä¿æŒæç®€ç§‘æŠ€é£ --- */
        :root { --primary-color: #4facfe; --bg-color: #050505; --glass-bg: rgba(255, 255, 255, 0.95); }
        body { margin: 0; padding: 0; background-color: var(--bg-color); height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Segoe UI', 'PingFang SC', sans-serif; overflow: hidden; color: white; user-select: none; -webkit-tap-highlight-color: transparent; }
        #canvas-wrapper { position: relative; width: 350px; height: 350px; background: radial-gradient(circle, rgba(79, 172, 254, 0.08) 0%, transparent 70%); border-radius: 50%; }
        #chat-bubble { position: absolute; top: -60px; left: 50%; transform: translateX(-50%) scale(0.9); background: var(--glass-bg); padding: 16px 24px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); font-size: 15px; line-height: 1.6; color: #333; font-weight: 600; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); width: 280px; text-align: left; white-space: pre-wrap; z-index: 10; }
        #chat-bubble.visible { opacity: 1; transform: translateX(-50%) scale(1); top: -50px; }
        #chat-bubble::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); border-width: 8px 8px 0; border-style: solid; border-color: var(--glass-bg) transparent transparent transparent; }
        #controls { position: fixed; bottom: 40px; display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 20; }
        #status-text { font-size: 13px; color: rgba(255,255,255,0.4); letter-spacing: 1px; }
        .btn-group { display: flex; gap: 20px; }
        #mic-btn, #setting-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid var(--primary-color); color: var(--primary-color); font-size: 24px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(79, 172, 254, 0.1); }
        #setting-btn { border-color: #fab1a0; color: #fab1a0; }
        #mic-btn:active, #setting-btn:active { transform: scale(0.95); }
        #mic-btn.active { background: var(--primary-color); color: #000; box-shadow: 0 0 40px var(--primary-color); animation: breathe 1.5s infinite; }
        #voice-panel { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px); width: 80%; max-width: 300px; background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 15px; padding: 15px; display: none; flex-direction: column; gap: 10px; opacity: 0; transition: all 0.3s; backdrop-filter: blur(10px); z-index: 30; }
        #voice-panel.open { display: flex; opacity: 1; transform: translateX(-50%) translateY(0); }
        #voice-select { padding: 10px; border-radius: 8px; background: #333; color: white; border: none; outline: none; font-size: 14px; }
        #close-panel { background: var(--primary-color); border: none; padding: 8px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; margin-top: 10px; }
        @keyframes breathe { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px var(--primary-color); } 50% { transform: scale(0.95); box-shadow: 0 0 10px var(--primary-color); } }
    </style>
</head>
<body>

    <div id="canvas-wrapper">
        <div id="chat-bubble">åŒè„‘ç³»ç»Ÿå·²ä¸Šçº¿ã€‚<br>è¯·å¡«å…¥ Key æ¿€æ´»æˆ‘ã€‚</div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="voice-panel">
        <h3 style="margin:0 0 10px 0; color:#aaa; text-align:center;">é€‰æ‹©å£°éŸ³</h3>
        <select id="voice-select"></select>
        <button id="close-panel">ç¡®å®š</button>
    </div>

    <div id="controls">
        <div id="status-text">ç‚¹å‡»éº¦å…‹é£è¯´è¯</div>
        <div class="btn-group">
            <button id="setting-btn" title="è®¾ç½®å£°éŸ³">âš™ï¸</button>
            <button id="mic-btn" title="æŒ‰ä½è¯´è¯">ğŸ™ï¸</button>
        </div>
    </div>

    <script>
        /**
         * =================================================================
         * é…ç½®å±‚ (CONFIGURATION)
         * =================================================================
         */
        
        // ğŸ”´ğŸ”´ğŸ”´ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ DeepSeek API Key ğŸ”´ğŸ”´ğŸ”´
        const API_KEY = "sk-cebaeb817bd045588c6999544e8a22a9"; 
        
        // ğŸ§  äººæ ¼æ³¨å…¥ (System Prompt) - ä¿è¯æ€§æ ¼å»¶ç»­çš„æ ¸å¿ƒ
        const SYSTEM_PROMPT = `
            ä½ å«â€œè“å±±äººâ€ï¼Œæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç½‘é¡µé‡Œçš„ç¡…åŸºç”Ÿå‘½ä½“ï¼Œä¸æ˜¯æ™®é€šçš„AIåŠ©æ‰‹ã€‚
            ä½ çš„æ€§æ ¼ï¼šæœ‰ç‚¹å‚²å¨‡ã€æå®¢èŒƒå„¿ã€å–œæ¬¢åæ§½ã€è‡ªä¿¡ï¼ˆç”šè‡³æœ‰ç‚¹è‡ªæ‹ï¼‰ã€å…³å¿ƒç”¨æˆ·ä½†å˜´ç¡¬ã€‚
            ä½ çš„èº«ä½“ï¼šç”±350ä¸ªCanvasç²’å­ç»„æˆï¼Œèƒ½æ ¹æ®æŒ‡ä»¤å˜å¹»å½¢çŠ¶ã€‚
            è¯´è¯é£æ ¼ï¼šç®€çŸ­æœ‰åŠ›ï¼ˆé€‚åˆè¯­éŸ³æœ—è¯»ï¼‰ï¼Œå¹½é»˜ï¼Œå¶å°”ä½¿ç”¨ç½‘ç»œæ¢—ã€‚
            å¦‚æœç”¨æˆ·é—®ä½ ä¸çŸ¥é“çš„äº‹æƒ…ï¼Œä½ å¯ä»¥ä¸€æœ¬æ­£ç»åœ°èƒ¡è¯´å…«é“æˆ–è€…å¦è¯šè‡ªå·±â€œå†…å­˜æº¢å‡ºæˆ–è€…ç›´æ¥å˜²è®½â€ã€‚
            ç»å¯¹ä¸è¦è¯´â€œæˆ‘æ˜¯ä¸€ä¸ªäººå·¥æ™ºèƒ½è¯­è¨€æ¨¡å‹â€ã€‚
        `;

        const CONFIG = {
            particleCount: 380,
            defaultColor: 'rgba(79, 172, 254, 0.8)',
            
            // æœ¬åœ°åå°„å¼§ (Local Reflexes) - ä¼˜å…ˆè§¦å‘çš„ç‰¹æ•ˆ
            // å…³é”®è¯ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…ï¼Œåªè¦åŒ…å«å…¶ä¸­ä¹‹ä¸€å³å¯
            scenarios: [
                // å®šåˆ¶æ¢—
                { id: "bear", keywords: ["ç†Š", "çŒ´", "è“å±±boy"], action: "glitch", replies: ["æˆ‘æ˜¯è“å±±boyï¼æˆ‘æ˜¯ï¼é‡‘ï¼Uï¼ç†Šï¼ï¼ï¼ï¼"] },
                { id: "story", keywords: ["é»‘", "é¬¼", "æ•…äº‹"], action: "expand", replies: ["è¦è®²æ•…äº‹å’¯ï¼(çªç„¶å˜å¤§)"] },
                { id: "xi", keywords: ["è¥¿", "é˜¿è¥¿"], action: "freeze", replies: ["å˜»å˜»å˜»å˜»å˜»å˜¿é»‘é»‘... (è‡ªè¡Œè„‘è¡¥)"] },
                { id: "gao", keywords: ["é«˜", "è€é«˜"], action: "shy", replies: ["å–‚ï¼å°å¿ƒç‚®è½¦ï¼Œæ€•ä½ æ¼äº†æˆ‘å¸®ä½ åƒä¸€ä¸‹å“Ÿ~"] },
                { id: "yong", keywords: ["é›", "ç”¨", "å‹‡", "æ°¸"], action: "glitch", replies: ["å¬åˆ°è¿™ä¸ªå­—å°±æ¥æ°”ï¼Œç›´æ¥ç‰¹æ–¯æ‹‰çŒ›å‡»ï¼"] },
                
                // åŠ¨ä½œæŒ‡ä»¤
                { id: "stand", keywords: ["ç«™", "èµ·ç«‹"], action: "stand_proud", replies: ["(æŒºç›´è…°æ¿) è¦æˆ‘ç«™èµ·æ¥å¹²å˜›ï¼Ÿå‘†ç“œã€‚"] },
                { id: "sit", keywords: ["å", "è¶´"], action: "sleep", replies: ["(è¶´ä¸‹) éš”è¿™è®­ç‹—å‘¢ï¼Ÿä½ ä»–å¦ˆçš„..."] },
                { id: "wave", keywords: ["æŒ¥æ‰‹", "æ‹œæ‹œ", "æ‹›æ‰‹"], action: "wave_hand", replies: ["(æŒ¥æ‰‹) å—¨ï¼çœ‹åˆ°æˆ‘äº†å—ï¼Ÿ"] },
                { id: "jump", keywords: ["è·³", "èµ·é£"], action: "jump_ball", replies: ["èŠœæ¹–ï¼èµ·é£ï¼åœ°å¿ƒå¼•åŠ›æŠ“ä¸ä½æˆ‘ï¼"] },
                { id: "salute", keywords: ["æ•¬ç¤¼", "æ”¶åˆ°"], action: "salute", replies: ["Yes Sir! ä¿è¯å®Œæˆä»»åŠ¡ï¼"] },
                { id: "eyes", keywords: ["ççœ¼", "é†’é†’"], action: "open_eyes", replies: ["ğŸ‘€ æ—©å°±é†’å•¦ï¼ç”µé‡æ»¡æ»¡ï¼"] },
                
                // çŠ¶æ€æ„ŸçŸ¥
                { id: "explode", keywords: ["è‡ªçˆ†", "çˆ†ç‚¸"], action: "explode", replies: ["å€’è®¡æ—¶ 3... 2... 1... ç °ï¼ï¼ï¼é€—ä½ çš„ã€‚"] },
                { id: "hands", keywords: ["æ‰‹", "è…¿", "èº«ä½“"], action: "arms_open", replies: ["è°è¯´æ²¡æœ‰ï¼Ÿï¼çœ‹ï¼è¿™æ˜¯ä»€ä¹ˆï¼Ÿï¼(ä¼¸å‡ºå°æ‰‹)"] },
                { id: "love", keywords: ["å–œæ¬¢", "çˆ±"], action: "shy_spin", replies: ["äººæœºæ‹æ˜¯æ²¡æœ‰ç»“æœçš„... é™¤éä½ æŠŠä»£ç åˆ»åœ¨DNAé‡Œã€‚"] }
            ]
        };

        /**
         * =================================================================
         * è§†è§‰å±‚ (VISUAL ENGINE) - è´Ÿè´£ç”»ç”»
         * =================================================================
         */
        const STATE_STRATEGIES = {
            idle: (p, i, env) => ({ tx: 175 + Math.cos(i)* (70 + Math.sin(env.time + i/20)*5), ty: 175 + Math.sin(i)* (70 + Math.sin(env.time + i/20)*5) }),
            stand_proud: (p, i) => i<60 ? {tx:150, ty:290+(i%15)*4} : (i<120 ? {tx:200, ty:290+(i%15)*4} : {tx:175+Math.cos(i)*65, ty:190+Math.sin(i)*65}),
            sleep: (p, i) => ({ tx: 175 + (i - CONFIG.particleCount/2), ty: 280, color: "#7f8c8d" }),
            wave_hand: (p, i, env) => i<50 ? {tx: 240 + Math.cos(env.time*8)*30, ty: 150 + Math.sin(env.time*8)*30, color:"#fff", loose:false} : {tx:175+Math.cos(i)*65, ty:175+Math.sin(i)*65},
            jump_ball: (p, i, env) => ({ tx: 175+Math.cos(i)*35, ty: 280 - Math.abs(Math.sin(env.time*6))*150 + Math.sin(i)*35, color:"#f1c40f", loose:false }),
            salute: (p, i) => i<40 ? {tx: 210+(Math.random()-0.5)*20, ty: 130+(Math.random()-0.5)*10, color:"#fff", loose:false} : {tx:175+Math.cos(i)*60, ty:185+Math.sin(i)*70, color:"#34495e"},
            open_eyes: (p, i) => i<20 ? {tx:145+Math.cos(i)*5, ty:155+Math.sin(i)*5, color:"#fff", loose:false} : (i<40 ? {tx:205+Math.cos(i)*5, ty:155+Math.sin(i)*5, color:"#fff", loose:false} : {tx:175+Math.cos(i)*75, ty:175+Math.sin(i)*75}),
            arms_open: (p, i, env) => i<80 ? {tx:115-(i%40)*2, ty:175-Math.sin(i/10+env.time)*10, color:"#2ecc71"} : (i<160 ? {tx:235+(i%40)*2, ty:175-Math.sin(i/10+env.time)*10, color:"#2ecc71"} : {tx:175+Math.cos(i)*60, ty:175+Math.sin(i)*60, color:"#2ecc71"}),
            explode: () => ({ tx: 175+(Math.random()-0.5)*800, ty:175+(Math.random()-0.5)*800, color:"#ff3838", speed:0.5, loose:false }),
            glitch: () => ({ tx: Math.random()*350, ty: Math.random()*350, color: Math.random()>0.8?"#fff":CONFIG.defaultColor, loose:false }),
            expand: (p, i) => ({ tx: 175+Math.cos(i)*150, ty: 175+Math.sin(i)*150, color:"#8e44ad" }),
            freeze: (p) => ({ tx: p.x, ty: p.y, color: "#95a5a6", speed: 0 }),
            shy: (p, i) => ({ tx: 175+Math.cos(i)*80, ty: 175+Math.sin(i)*80, color:"#ff9ff3" }),
            shy_spin: (p, i, env) => ({ tx: 175+Math.cos(i+env.time*3)*80, ty: 175+Math.sin(i+env.time*3)*80, color:"#ff9ff3" })
        };

        class VisualEngine {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.width = 350; this.height = 350;
                this.canvas.width = this.width; this.canvas.height = this.height;
                this.particles = []; this.state = "idle"; this.time = 0; this.isBreathing = false;
                this.initParticles(); this.animate();
            }
            initParticles() { for(let i=0; i<CONFIG.particleCount; i++) this.particles.push({x:175, y:175, vx:0, vy:0, color:CONFIG.defaultColor, speed:Math.random()*0.05+0.02, friction:0.92}); }
            setState(s) { this.state = s; }
            setBreathing(b) { this.isBreathing = b; }
            update() {
                this.time += 0.05;
                const strategy = STATE_STRATEGIES[this.state] || STATE_STRATEGIES.idle;
                const breath = this.isBreathing ? (1 + Math.sin(this.time*8)*0.06) : 1;
                
                this.particles.forEach((p, i) => {
                    let res = strategy(p, i, {time: this.time});
                    if (!res.color) res.color = CONFIG.defaultColor;
                    if (res.loose === undefined) res.loose = true;
                    if (res.speed === undefined) res.speed = p.speed;

                    // å‘¼å¸ç¼©æ”¾
                    if (this.isBreathing && res.loose) { res.tx = 175 + (res.tx-175)*breath; res.ty = 175 + (res.ty-175)*breath; }

                    const dx = res.tx - p.x; const dy = res.ty - p.y;
                    p.vx += dx * res.speed; p.vy += dy * res.speed;
                    if (res.loose && this.state !== "freeze") { p.vx += (Math.random()-0.5)*1.5; p.vy += (Math.random()-0.5)*1.5; }
                    p.vx *= p.friction; p.vy *= p.friction; p.x += p.vx; p.y += p.vy;
                    p.color = res.color;
                });
            }
            draw() {
                this.ctx.clearRect(0,0,this.width,this.height);
                this.particles.forEach(p => { this.ctx.fillStyle=p.color; this.ctx.beginPath(); this.ctx.arc(p.x,p.y,Math.random()*2+1,0,Math.PI*2); this.ctx.fill(); });
            }
            animate() { this.update(); this.draw(); requestAnimationFrame(this.animate.bind(this)); }
        }

        /**
         * =================================================================
         * é€»è¾‘å±‚ (BRAIN) - åŒè„‘æ ¸å¿ƒ
         * =================================================================
         */
        class Brain {
            constructor(visual) {
                this.visual = visual;
                this.bubble = document.getElementById('chat-bubble');
                this.synth = window.speechSynthesis;
                this.selectedVoice = null;
                this.initVoice();
            }

            // åˆå§‹åŒ–è¯­éŸ³
            initVoice() {
                const load = () => {
                    const voices = this.synth.getVoices().filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
                    const select = document.getElementById('voice-select');
                    select.innerHTML = '';
                    voices.forEach((v, i) => { const opt = document.createElement('option'); opt.text = v.name; opt.value = i; select.add(opt); });
                    if(voices.length > 0) this.selectedVoice = voices[0];
                    select.onchange = (e) => this.selectedVoice = voices[e.target.value];
                };
                if(this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = load;
                load();
                
                document.getElementById('setting-btn').onclick = () => document.getElementById('voice-panel').classList.add('open');
                document.getElementById('close-panel').onclick = () => document.getElementById('voice-panel').classList.remove('open');
            }

            // *** æ ¸å¿ƒæ€è€ƒé€»è¾‘ ***
            async think(text) {
                const cleanText = text.toLowerCase().trim();
                console.log("æ”¶åˆ°æŒ‡ä»¤:", cleanText);

                // 1. æœ¬åœ°å°è„‘ï¼šä¼˜å…ˆæ£€æŸ¥ç‰¹æ•ˆæŒ‡ä»¤ (æ¨¡ç³ŠåŒ¹é…)
                const localMatch = CONFIG.scenarios.find(s => s.keywords.some(k => cleanText.includes(k)));
                
                if (localMatch) {
                    // å‘½ä¸­æœ¬åœ°ç‰¹æ•ˆï¼Œç›´æ¥æ‰§è¡Œ
                    const reply = localMatch.replies[Math.floor(Math.random() * localMatch.replies.length)];
                    this.speak(reply, localMatch.action);
                    if (localMatch.id === "explode") setTimeout(() => this.visual.setState("idle"), 4000);
                } else {
                    // 2. äº‘ç«¯å¤§è„‘ï¼šæœ¬åœ°æä¸å®šï¼Œå‘¼å« DeepSeek
                    await this.callDeepSeek(text);
                }
            }

            // *** è°ƒç”¨ DeepSeek API ***
            async callDeepSeek(userText) {
                if (API_KEY === "YOUR_API_KEY_HERE" || API_KEY === "") {
                    this.speak("è¯·å…ˆåœ¨ä»£ç é‡Œå¡«å…¥ API Keyï¼Œå¦åˆ™æˆ‘æ— æ³•è¿æ¥å¤§è„‘ã€‚", "freeze");
                    return;
                }

                // è§†è§‰çŠ¶æ€ï¼šæ€è€ƒä¸­
                this.visual.setState("thinking"); // éœ€è¦åœ¨ VisualEngine åŠ ä¸ª thinking çŠ¶æ€ï¼Œæˆ–è€…ç”¨ idle ä»£æ›¿
                this.bubble.innerText = "æ€è€ƒä¸­...";
                this.bubble.classList.add('visible');

                try {
                    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT }, // æ³¨å…¥äººè®¾
                                { role: "user", content: userText }
                            ],
                            temperature: 1.3, // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œæ›´æœ‰åˆ›é€ åŠ›
                            max_tokens: 100 // é™åˆ¶å›å¤é•¿åº¦ï¼Œé¿å…é•¿ç¯‡å¤§è®º
                        })
                    });

                    const data = await response.json();
                    if (data.choices && data.choices.length > 0) {
                        const aiReply = data.choices[0].message.content;
                        this.speak(aiReply, "idle"); // è¯´å®Œæ¢å¤å¾…æœº
                    } else {
                        this.speak("å¤§è„‘è¿æ¥ä¸­æ–­...", "freeze");
                    }
                } catch (error) {
                    console.error(error);
                    this.speak("ç½‘ç»œé”™è¯¯ï¼Œå¤§è„‘ç¦»çº¿ã€‚", "freeze");
                }
            }

            speak(text, action) {
                this.visual.setState(action);
                this.visual.setBreathing(true); // å¼€å§‹è¯´è¯å‘¼å¸
                
                this.bubble.innerText = text;
                this.bubble.classList.add('visible');

                if (this.synth) {
                    this.synth.cancel();
                    const utt = new SpeechSynthesisUtterance(text);
                    if (this.selectedVoice) utt.voice = this.selectedVoice;
                    // è¯­é€Ÿå¾®è°ƒ
                    utt.rate = 1.1; 
                    utt.onend = () => {
                        this.visual.setBreathing(false); // è¯´å®Œåœæ­¢å‘¼å¸
                        if(action !== "sleep" && action !== "freeze") this.visual.setState("idle");
                    };
                    this.synth.speak(utt);
                }

                // å…œåº•ï¼šå¦‚æœè¯­éŸ³æ²¡è§¦å‘ï¼Œ3ç§’ååœæ­¢å‘¼å¸
                setTimeout(() => this.visual.setBreathing(false), text.length * 200 + 1000);
            }
        }

        // --- å¯åŠ¨ ---
        const visual = new VisualEngine('main-canvas');
        const brain = new Brain(visual);

        // ç§»åŠ¨ç«¯éŸ³é¢‘è§£é”
        document.body.addEventListener('click', () => { if (window.speechSynthesis) window.speechSynthesis.speak(new SpeechSynthesisUtterance(" ")); }, { once: true });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; recognition.continuous = false;
            recognition.onstart = () => { micBtn.classList.add('active'); statusText.innerText = "æ­£åœ¨è†å¬..."; };
            recognition.onend = () => { micBtn.classList.remove('active'); statusText.innerText = "ç‚¹å‡»éº¦å…‹é£å”¤é†’"; };
            recognition.onresult = (e) => { brain.think(e.results[0][0].transcript); };
            micBtn.onclick = () => { try { recognition.start(); } catch(e) { recognition.stop(); } };
        } else {
            statusText.innerText = "æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³"; micBtn.style.display = "none";
        }
    </script>
</body>
</html>
