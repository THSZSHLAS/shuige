<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. Protocol</title>
    <style>
        /* --- è´¾ç»´æ–¯å…¨æ¯é£æ ¼ UI --- */
        :root { --primary: #00f2fe; --alert: #ff4757; --bg: #000; --panel: rgba(16, 30, 40, 0.9); }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Segoe UI', monospace; color: var(--primary); overflow: hidden; }

        /* èƒŒæ™¯ç½‘æ ¼çº¿ï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ */
        .grid-bg { position: absolute; width: 100%; height: 100%; background: linear-gradient(rgba(0, 242, 254, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 254, 0.05) 1px, transparent 1px); background-size: 40px 40px; z-index: -1; pointer-events: none; }

        /* æ ¸å¿ƒååº”å † */
        #arc-reactor { position: relative; width: 320px; height: 320px; border-radius: 50%; border: 1px solid rgba(0, 242, 254, 0.3); display: flex; justify-content: center; align-items: center; box-shadow: 0 0 50px rgba(0, 242, 254, 0.1); transition: all 0.5s; }
        #main-canvas { width: 100%; height: 100%; border-radius: 50%; opacity: 0.8; }

        /* è§†é¢‘/è§†è§‰å±‚ (éšè—ï¼Œæ¿€æ´»æ—¶æ˜¾ç¤º) */
        #vision-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        #vision-ui { position: absolute; bottom: 50px; display: flex; gap: 20px; z-index: 51; }
        .hud-line { position: absolute; width: 100%; height: 2px; background: var(--primary); top: 50%; animation: scan 2s infinite linear; opacity: 0.5; box-shadow: 0 0 10px var(--primary); pointer-events: none; }

        /* å¯¹è¯æ°”æ³¡ (HUDæ ·å¼) */
        #hud-display {
            position: absolute; top: 15%; width: 85%; max-width: 400px;
            padding: 15px; border-left: 3px solid var(--primary);
            background: linear-gradient(90deg, rgba(0,242,254,0.1), transparent);
            font-size: 16px; line-height: 1.5; text-shadow: 0 0 5px var(--primary);
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        #hud-display.active { opacity: 1; }

        /* æ§åˆ¶é¢æ¿ */
        #control-deck { position: fixed; bottom: 30px; display: flex; gap: 20px; z-index: 10; padding: 10px 20px; background: rgba(0,0,0,0.5); border-radius: 30px; border: 1px solid rgba(0,242,254,0.2); backdrop-filter: blur(5px); }
        .jarvis-btn { 
            width: 50px; height: 50px; border-radius: 50%; background: transparent; 
            border: 1px solid var(--primary); color: var(--primary); font-size: 20px; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            transition: 0.3s; box-shadow: 0 0 10px rgba(0,242,254,0.1); 
        }
        .jarvis-btn:active { transform: scale(0.9); background: var(--primary); color: #000; }
        .jarvis-btn.active { background: rgba(0,242,254,0.2); box-shadow: 0 0 20px var(--primary); }

        /* è®¾ç½®é¢æ¿ */
        #settings-panel { position: fixed; bottom: 100px; background: var(--panel); border: 1px solid var(--primary); padding: 20px; border-radius: 10px; display: none; color: white; width: 250px; }
        select { width: 100%; padding: 8px; background: #000; color: var(--primary); border: 1px solid var(--primary); margin-top: 5px; }

        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body>

    <div class="grid-bg"></div>

    <div id="hud-display">Initializing J.A.R.V.I.S...<br>System Online.</div>

    <div id="arc-reactor">
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="vision-layer">
        <video id="camera-feed" autoplay playsinline></video>
        <div class="hud-line"></div>
        <div id="vision-ui">
            <button class="jarvis-btn" id="capture-btn" title="åˆ†æç”»é¢">ğŸ“¸</button>
            <button class="jarvis-btn" id="switch-cam-btn" title="åˆ‡æ¢é•œå¤´">ğŸ”„</button>
            <button class="jarvis-btn" id="close-vision-btn" style="border-color:var(--alert); color:var(--alert);">âœ–</button>
        </div>
    </div>

    <div id="control-deck">
        <button class="jarvis-btn" id="mute-btn">ğŸ”Š</button>
        <button class="jarvis-btn" id="vision-btn">ğŸ‘ï¸</button>
        <button class="jarvis-btn" id="mic-btn" style="width:60px; height:60px; font-size:26px;">ğŸ™ï¸</button>
        <button class="jarvis-btn" id="setting-btn">âš™ï¸</button>
    </div>

    <div id="settings-panel">
        <label>Voice Module:</label>
        <select id="voice-select"></select>
    </div>

    <script>
        /**
         * =================================================================
         * ğŸ”´ ä½ çš„é…ç½®
         * =================================================================
         */
        const API_KEY = "sk-cebaeb817bd045588c6999544e8a22a9"; // å»ºè®®ä½¿ç”¨æ”¯æŒè¯†å›¾çš„æ¨¡å‹API
        const MODEL_NAME = "deepseek-chat"; // å¦‚æœæœ‰è§†è§‰éœ€æ±‚ï¼Œè¿™é‡Œæ”¹ä¸º "gpt-4o" æˆ– "qwen-vl-max"

        // ğŸ§  é•¿æœŸè®°å¿† (æµ·é©¬ä½“) - åªè¦ä¸åˆ·æ–°ç½‘é¡µï¼Œè®°å¿†å°±ä¸€ç›´åœ¨
        let chatHistory = [
            { role: "system", content: "ä½ å«Jarvisã€‚ä½ æ˜¯å…¨èƒ½ç§äººç®¡å®¶ã€‚è¯·ç”¨ç®€ç»ƒã€ä¸“ä¸šã€ç”šè‡³å¸¦ç‚¹å¹½é»˜çš„é£æ ¼å›ç­”ã€‚ä½ éœ€è¦ä¸»åŠ¨æ€è€ƒç”¨æˆ·çš„æ½œåœ¨éœ€æ±‚ã€‚ä¾‹å¦‚ç”¨æˆ·é—®å¤©æ°”ï¼Œä½ è¦ç»“åˆå¤©æ°”ç»™å‡ºç©¿è¡£æˆ–å‡ºè¡Œå»ºè®®ã€‚" }
        ];

        /**
         * 1. çœŸå®æ„ŸçŸ¥æ¨¡å— (Weather & Time)
         * å‡è£… AI è”ç½‘ï¼Œå®é™…ä¸Šæ˜¯æˆ‘ä»¬å‰ç«¯æŸ¥å¥½å‘ç»™å®ƒ
         */
        async function getRealWorldContext() {
            const now = new Date();
            let context = `Current Time: ${now.toLocaleString()}.\n`;
            
            // å°è¯•è·å–å¤©æ°” (ä½¿ç”¨å…è´¹çš„ Open-Meteo API)
            try {
                // é»˜è®¤ä½ç½® (å¦‚æœæ²¡æœ‰å¼€å¯å®šä½æƒé™ï¼Œé»˜è®¤åŒ—äº¬)
                let lat = 39.9042, lon = 116.4074; 
                
                // ç®€å•çš„å¤©æ°”è·å–é€»è¾‘
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const weatherData = await weatherRes.json();
                const t = weatherData.current_weather;
                context += `Current Weather: Temp ${t.temperature}Â°C, Wind ${t.windspeed}km/h.`;
            } catch (e) {
                context += "Weather Data: Offline.";
            }
            return context;
        }

        /**
         * 2. å¤§è„‘é€»è¾‘ (Brain)
         */
        class Brain {
            constructor(visual) {
                this.visual = visual;
                this.synth = window.speechSynthesis;
                this.voice = null;
                this.voiceEnabled = true;
                this.isProcessing = false;

                this.initVoice();
            }

            // ä¿®å¤ï¼šç¡®ä¿å£°éŸ³åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå¹¶æŒä¹…åŒ–é€‰æ‹©
            initVoice() {
                const load = () => {
                    const voices = this.synth.getVoices().filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
                    const select = document.getElementById('voice-select');
                    select.innerHTML = '';
                    voices.forEach((v, i) => { 
                        const opt = document.createElement('option'); 
                        opt.text = v.name; opt.value = i; select.add(opt); 
                    });
                    if (voices.length > 0) this.voice = voices[0];
                    
                    select.onchange = (e) => {
                        this.voice = voices[e.target.value];
                        this.speak("Voice calibrated, sir.", "nod"); // è¯•å¬
                    };
                };
                this.synth.onvoiceschanged = load;
                load();
            }

            async process(text, imageBase64 = null) {
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.visual.setState("thinking");
                ui.log("Processing Data...", true);

                // 1. è·å–ç¯å¢ƒæ•°æ®
                const worldContext = await getRealWorldContext();
                
                // 2. æ„å»ºè®°å¿†é“¾
                // æŠŠæ–°çš„ç”¨æˆ·è¾“å…¥åŠ è¿›å»
                let newUserMsg = { role: "user", content: text };
                
                // å¦‚æœæœ‰å›¾ç‰‡ (è§†è§‰æ¨¡å¼)
                if (imageBase64) {
                    // æ³¨æ„ï¼šDeepSeek åŸç”ŸAPIä¸æ”¯æŒå›¾ç‰‡ï¼Œå¦‚æœè¿™é‡Œæ˜¯çº¯DeepSeek Keyï¼Œè¿™æ­¥ä¼šå¤±è´¥æˆ–è€…éœ€è¦è½¬å‘ã€‚
                    // è¿™é‡Œå†™çš„æ˜¯æ ‡å‡† OpenAI è§†è§‰æ ¼å¼
                    newUserMsg.content = [
                        { type: "text", text: text + ` (Context: ${worldContext})` },
                        { type: "image_url", image_url: { url: imageBase64 } }
                    ];
                } else {
                    newUserMsg.content = text + `\n[System Note: ${worldContext}]`;
                }

                chatHistory.push(newUserMsg);
                
                // ä¿æŒè®°å¿†é•¿åº¦åœ¨ 10 æ¡ä»¥å†…ï¼Œé˜²æ­¢ token çˆ†ç‚¸
                if (chatHistory.length > 10) chatHistory.splice(1, 2); 

                try {
                    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify({
                            model: MODEL_NAME,
                            messages: chatHistory, // å‘é€å®Œæ•´å†å²
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);

                    const aiText = data.choices[0].message.content;
                    
                    // å­˜å…¥è®°å¿†
                    chatHistory.push({ role: "assistant", content: aiText });

                    ui.log(aiText);
                    this.speak(aiText, "happy");

                } catch (error) {
                    console.error(error);
                    ui.log("Connection Error: " + error.message);
                    this.speak("ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿã€‚", "shake");
                } finally {
                    this.isProcessing = false;
                    this.visual.setState("idle");
                }
            }

            speak(text, action) {
                if (!this.voiceEnabled) return;
                this.synth.cancel(); // æ‰“æ–­ä¸Šä¸€å¥
                const utt = new SpeechSynthesisUtterance(text);
                if (this.voice) utt.voice = this.voice; // ğŸ”´ å…³é”®ä¿®å¤ï¼šæ¯æ¬¡éƒ½é‡æ–°æŒ‡å®šå£°éŸ³
                utt.rate = 1.0; 
                utt.pitch = 1.0;
                this.synth.speak(utt);
                
                // ç®€å•çš„çŠ¶æ€è”åŠ¨
                this.visual.setBreathing(true);
                utt.onend = () => this.visual.setBreathing(false);
            }
        }

        /**
         * 3. è§†è§‰å¼•æ“ (Canvas Particles)
         */
        class VisualEngine {
            constructor() {
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                this.particles = [];
                this.state = "idle";
                this.breathing = false;
                this.initParticles();
                this.loop();
                window.onresize = () => this.resize();
            }
            resize() { this.canvas.width = 320; this.canvas.height = 320; }
            initParticles() {
                for(let i=0; i<100; i++) {
                    this.particles.push({
                        angle: Math.random() * Math.PI * 2,
                        radius: 50 + Math.random() * 100,
                        speed: 0.02 + Math.random() * 0.03
                    });
                }
            }
            setState(s) { this.state = s; }
            setBreathing(b) { this.breathing = b; }
            
            loop() {
                this.ctx.clearRect(0, 0, 320, 320);
                this.ctx.translate(160, 160);
                
                const color = this.state === "thinking" ? "#a29bfe" : (this.state === "happy" ? "#00f2fe" : "#ff4757");
                this.ctx.strokeStyle = color;
                this.ctx.fillStyle = color;

                // ç®€å•çš„æ–¹èˆŸååº”å †åŠ¨ç”»
                this.particles.forEach((p, i) => {
                    p.angle += p.speed * (this.state === "thinking" ? 5 : 1);
                    const r = p.radius + (this.breathing ? Math.sin(Date.now()/200)*10 : 0);
                    const x = Math.cos(p.angle) * r;
                    const y = Math.sin(p.angle) * r;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 2, 0, Math.PI*2);
                    this.ctx.fill();
                    
                    // è¿çº¿
                    if (i > 0) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, y);
                        const prev = this.particles[i-1];
                        this.ctx.lineTo(Math.cos(prev.angle)*prev.radius, Math.sin(prev.angle)*prev.radius);
                        this.ctx.globalAlpha = 0.1;
                        this.ctx.stroke();
                        this.ctx.globalAlpha = 1;
                    }
                });

                // ä¸­å¿ƒåœ†
                this.ctx.beginPath();
                this.ctx.arc(0, 0, 40 + (this.breathing ? Math.sin(Date.now()/200)*5 : 0), 0, Math.PI*2);
                this.ctx.stroke();

                this.ctx.translate(-160, -160);
                requestAnimationFrame(this.loop.bind(this));
            }
        }

        /**
         * 4. è§†è§‰å±‚é€»è¾‘ (Camera)
         */
        const visionLayer = {
            el: document.getElementById('vision-layer'),
            video: document.getElementById('camera-feed'),
            active: false,
            stream: null,
            facingMode: 'environment', // é»˜è®¤åç½®

            async open() {
                this.el.style.display = 'flex';
                this.active = true;
                await this.startCamera();
                brain.speak("Vision systems online.", "thinking");
            },
            async close() {
                this.el.style.display = 'none';
                this.active = false;
                if (this.stream) this.stream.getTracks().forEach(t => t.stop());
            },
            async startCamera() {
                if (this.stream) this.stream.getTracks().forEach(t => t.stop());
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: this.facingMode } 
                    });
                    this.video.srcObject = this.stream;
                } catch (e) {
                    ui.log("Camera Access Denied");
                }
            },
            toggle() { this.facingMode = this.facingMode === 'user' ? 'environment' : 'user'; this.startCamera(); },
            capture() {
                const cvs = document.createElement('canvas');
                cvs.width = this.video.videoWidth; cvs.height = this.video.videoHeight;
                cvs.getContext('2d').drawImage(this.video, 0, 0);
                return cvs.toDataURL('image/jpeg', 0.7); // è¿”å› Base64
            }
        };

        /**
         * 5. UI æ§åˆ¶
         */
        const ui = {
            hud: document.getElementById('hud-display'),
            log: (text, isSystem = false) => {
                ui.hud.innerHTML = text;
                ui.hud.classList.add('active');
                if (!isSystem) setTimeout(() => ui.hud.classList.remove('active'), 5000);
            }
        };

        // --- åˆå§‹åŒ– ---
        const visual = new VisualEngine();
        const brain = new Brain(visual);

        // --- æŒ‰é’®ç»‘å®š ---
        document.getElementById('mic-btn').onclick = () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³");
            
            const rec = new SpeechRecognition();
            rec.lang = 'zh-CN';
            rec.onstart = () => { visual.setState("thinking"); document.getElementById('mic-btn').classList.add('active'); };
            rec.onend = () => document.getElementById('mic-btn').classList.remove('active');
            rec.onresult = (e) => {
                const text = e.results[0][0].transcript;
                brain.process(text);
            };
            rec.start();
        };

        document.getElementById('vision-btn').onclick = () => visionLayer.open();
        document.getElementById('close-vision-btn').onclick = () => visionLayer.close();
        document.getElementById('switch-cam-btn').onclick = () => visionLayer.toggle();
        document.getElementById('capture-btn').onclick = () => {
            // æ‹ç…§ -> å‘é€
            const img = visionLayer.capture();
            visionLayer.close();
            ui.log("Analyzing image...");
            brain.process("è¿™å¼ å›¾ç‰‡é‡Œæœ‰ä»€ä¹ˆï¼Ÿè¯·è¯¦ç»†åˆ†æã€‚", img);
        };

        document.getElementById('mute-btn').onclick = function() {
            brain.voiceEnabled = !brain.voiceEnabled;
            this.innerText = brain.voiceEnabled ? "ğŸ”Š" : "ğŸ”‡";
        };
        
        document.getElementById('setting-btn').onclick = () => {
            const p = document.getElementById('settings-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        };

        // é¦–æ¬¡ç‚¹å‡»æ¿€æ´»è¯­éŸ³åˆæˆ
        document.body.onclick = () => { window.speechSynthesis.speak(new SpeechSynthesisUtterance(" ")); document.body.onclick = null; };

    </script>
</body>
</html>
