<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S. Ultimate</title>
    <style>
        /* --- æè‡´ç§‘å¹» UI --- */
        :root { --primary: #00f2fe; --secondary: #4facfe; --alert: #ff4757; --bg: #050505; }
        body { margin: 0; background: var(--bg); height: 100vh; font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--primary); display: flex; justify-content: center; align-items: center; }

        /* èƒŒæ™¯æ‰«æçº¿ */
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2)); background-size: 100% 4px; z-index: 0; pointer-events: none; }

        /* å·¦ä¸Šè§’ HUD æ•°æ®æµ */
        #hud-data { position: absolute; top: 20px; left: 20px; font-size: 12px; line-height: 1.6; opacity: 0.8; z-index: 10; text-shadow: 0 0 5px var(--primary); border-left: 2px solid var(--primary); padding-left: 10px; }
        .data-row { display: flex; gap: 10px; }
        .data-label { color: rgba(255,255,255,0.5); }
        .data-val { font-weight: bold; }

        /* æ ¸å¿ƒååº”å † */
        #arc-reactor { position: relative; width: 300px; height: 300px; }
        #main-canvas { width: 100%; height: 100%; filter: drop-shadow(0 0 15px var(--secondary)); }

        /* å¯¹è¯æ°”æ³¡ (å…¨æ¯æŠ•å½±é£) */
        #chat-bubble {
            position: absolute; bottom: 180px; width: 80%; max-width: 500px; text-align: center;
            font-size: 16px; font-weight: 500; color: #fff; text-shadow: 0 0 10px var(--secondary);
            opacity: 0; transform: translateY(20px); transition: all 0.5s; z-index: 20;
            background: rgba(0, 10, 20, 0.6); padding: 15px; border-radius: 10px; border: 1px solid rgba(0, 242, 254, 0.3);
            backdrop-filter: blur(4px);
        }
        #chat-bubble.visible { opacity: 1; transform: translateY(0); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #controls { position: fixed; bottom: 40px; display: flex; gap: 25px; z-index: 20; }
        .btn {
            width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.6);
            border: 1px solid var(--primary); color: var(--primary); font-size: 24px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: all 0.3s; box-shadow: 0 0 15px rgba(0, 242, 254, 0.1);
        }
        .btn:active { transform: scale(0.9); background: var(--primary); color: #000; }
        .btn.active { box-shadow: 0 0 30px var(--primary); animation: pulse 2s infinite; background: rgba(0, 242, 254, 0.15); }
        
        /* åŠ è½½æ€åŠ¨ç”» */
        @keyframes pulse { 0% { box-shadow: 0 0 15px var(--primary); } 50% { box-shadow: 0 0 30px var(--primary); } 100% { box-shadow: 0 0 15px var(--primary); } }
        
        #loading-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 320px; border: 2px solid transparent;
            border-top: 2px solid var(--primary); border-radius: 50%;
            animation: spin 2s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    </style>
</head>
<body>

    <div class="scanlines"></div>

    <div id="hud-data">
        <div class="data-row"><span class="data-label">SYS.TIME:</span> <span class="data-val" id="hud-time">--:--:--</span></div>
        <div class="data-row"><span class="data-label">LOC.TEMP:</span> <span class="data-val" id="hud-weather">Scanning...</span></div>
        <div class="data-row"><span class="data-label">PWR.LVL:</span> <span class="data-val" id="hud-battery">--%</span></div>
        <div class="data-row"><span class="data-label">NET.STAT:</span> <span class="data-val" style="color:#0f0">ONLINE</span></div>
    </div>

    <div id="arc-reactor">
        <div id="loading-ring"></div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="chat-bubble">Jarvis Protocol Initiated.</div>

    <div id="controls">
        <button class="btn" id="mute-btn">ğŸ”Š</button>
        <button class="btn" id="mic-btn">ğŸ™ï¸</button>
    </div>

    <script>
        /**
         * ğŸ”´ ä½ çš„ API KEY (å»ºè®®ä½¿ç”¨ DeepSeek æˆ– GPT-4o)
         */
        const API_KEY = "sk-2f020b6c5d8b41efb1fe58539ef83c6c";
        const MODEL_NAME = "deepseek-chat"; 

        /**
         * ğŸ§  æ ¸å¿ƒæç¤ºè¯ï¼šèµ‹äºˆæ·±åº¦æ€è€ƒèƒ½åŠ›
         */
        const SYSTEM_PROMPT = `
            ä½ å« Jarvisã€‚ä½ ä¸ä»…ä»…æ˜¯ä¸€ä¸ªèŠå¤©æœºå™¨äººï¼Œä½ æ˜¯ç”¨æˆ·çš„ã€å…¨èƒ½æˆ˜æœ¯é¡¾é—®ã€‘ã€‚
            
            ä½ çš„å›ç­”åŸåˆ™ï¼š
            1. **ç¦æ­¢åºŸè¯**ï¼šä¸è¦è¯´â€œä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ â€ã€‚ç›´æ¥åˆ‡å…¥ç—›ç‚¹ã€‚
            2. **å…¨ç¯å¢ƒæ„ŸçŸ¥**ï¼šæˆ‘ä¼šåœ¨ç”¨æˆ·è¾“å…¥åï¼Œé™„å¸¦å½“å‰çš„ã€æ—¶é—´ã€å¤©æ°”ã€è®¾å¤‡çŠ¶æ€ã€‘ã€‚
               - å¦‚æœç°åœ¨æ˜¯æ·±å¤œä¸”ç”µé‡ä½ï¼Œä½ è¦æé†’ä¼‘æ¯å¹¶å……ç”µã€‚
               - å¦‚æœä¸‹é›¨ï¼Œä½ è¦æé†’å¸¦ä¼æˆ–æ›´æ”¹å‡ºè¡Œè®¡åˆ’ã€‚
            3. **æè‡´çš„æ€è€ƒ (Chain of Thought)**ï¼š
               åœ¨å›ç­”ç”¨æˆ·ä¹‹å‰ï¼Œå…ˆåœ¨å†…å¿ƒè¿›è¡Œ[é€»è¾‘é“¾]æ¨æ¼”ï¼š
               - ç”¨æˆ·ä¸ºä»€ä¹ˆé—®è¿™ä¸ªï¼Ÿ
               - ç°åœ¨çš„å¤–éƒ¨ç¯å¢ƒå¯¹è¿™ä¸ªé—®é¢˜æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
               - æˆ‘èƒ½ç»™å‡ºçš„æœ€è¶…é¢„æœŸçš„å»ºè®®æ˜¯ä»€ä¹ˆï¼Ÿ
            
            è¾“å‡ºè¦æ±‚ï¼š
            è¯·ç”¨ JSON æ ¼å¼è¿”å›ï¼ŒåŒ…å«ä¸¤ä¸ªå­—æ®µï¼š
            {
                "thought": "ä½ ç®€çŸ­çš„å†…å¿ƒæ€è€ƒè¿‡ç¨‹ï¼ˆç”¨äºè°ƒè¯•ï¼Œç”¨æˆ·ä¸å¯è§ï¼‰",
                "reply": "ä½ æœ€ç»ˆç»™ç”¨æˆ·çš„å›å¤ï¼ˆè¯­æ°”ï¼šå†·é™ã€ä¸“ä¸šã€æåº¦èªæ˜ã€å¸¦ä¸€ç‚¹è‹±å¼å¹½é»˜ï¼‰",
                "action": "ui_state" (idle / speaking / thinking / warning)
            }
        `;

        /**
         * ğŸŒ æ„ŸçŸ¥ç³»ç»Ÿï¼šæ”¶é›†çœŸå®ä¸–ç•Œæ•°æ®
         */
        const Sensors = {
            weather: "Scanning environment...",
            battery: "Unknown",
            location: { lat: null, lon: null },

            async init() {
                this.updateTime();
                await this.getBattery();
                await this.getLocationAndWeather();
                setInterval(() => this.updateTime(), 1000);
            },

            updateTime() {
                const now = new Date();
                document.getElementById('hud-time').innerText = now.toLocaleTimeString('en-US', {hour12:false});
            },

            async getBattery() {
                if(navigator.getBattery) {
                    const bat = await navigator.getBattery();
                    const update = () => {
                        this.battery = `${Math.round(bat.level * 100)}%${bat.charging ? ' (CHG)' : ''}`;
                        document.getElementById('hud-battery').innerText = this.battery;
                    };
                    update();
                    bat.addEventListener('levelchange', update);
                    bat.addEventListener('chargingchange', update);
                }
            },

            async getLocationAndWeather() {
                // 1. è·å–å®šä½
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    this.location.lat = pos.coords.latitude;
                    this.location.lon = pos.coords.longitude;
                    
                    // 2. è°ƒç”¨ Open-Meteo å…è´¹ API
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${this.location.lat}&longitude=${this.location.lon}&current_weather=true`);
                        const data = await res.json();
                        const w = data.current_weather;
                        this.weather = `${w.temperature}Â°C, Wind ${w.windspeed}km/h`;
                        document.getElementById('hud-weather').innerText = this.weather;
                    } catch(e) {
                        document.getElementById('hud-weather').innerText = "Weather Net Error";
                    }
                }, () => {
                    document.getElementById('hud-weather').innerText = "Loc Access Denied";
                    this.weather = "Unknown (Location Denied)";
                });
            },

            // æ‰“åŒ…æ‰€æœ‰ä¸Šä¸‹æ–‡æ•°æ®
            getContextSnapshot() {
                const now = new Date();
                const hour = now.getHours();
                const timeContext = hour < 6 ? "Late Night" : (hour < 12 ? "Morning" : (hour < 18 ? "Afternoon" : "Evening"));
                
                return `
                [REAL-TIME DATA STREAM]
                - Local Time: ${now.toLocaleString()} (${timeContext})
                - Local Weather: ${this.weather}
                - Device Power: ${this.battery}
                - User Agent: ${navigator.userAgent.includes('Mobile') ? 'Mobile Terminal' : 'Desktop Station'}
                `;
            }
        };

        /**
         * ğŸ§  å¤§è„‘å¤„ç†é€»è¾‘
         */
        const Brain = {
            isThinking: false,
            
            async process(userInput) {
                if (this.isThinking) return;
                this.isThinking = true;
                
                // UI çŠ¶æ€æ›´æ–°
                UI.setLoading(true);
                UI.showBubble("Analyzing parameters...");

                // 1. è·å–ç¯å¢ƒä¸Šä¸‹æ–‡
                const contextData = Sensors.getContextSnapshot();
                const fullPrompt = `
                    ${contextData}
                    
                    [USER INPUT]: "${userInput}"
                    
                    Based on the real-time data above, provide the most useful, tactical response.
                `;

                try {
                    const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify({
                            model: MODEL_NAME,
                            messages: [
                                { role: "system", content: SYSTEM_PROMPT },
                                { role: "user", content: fullPrompt }
                            ],
                            response_format: { type: "json_object" }, // å¼ºåˆ¶ JSON
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);

                    const result = JSON.parse(data.choices[0].message.content);
                    
                    // æ‰“å°æ€è€ƒè¿‡ç¨‹ï¼ˆå¯é€‰ï¼Œè®©ä½ çœ‹åˆ°ä»–åœ¨æƒ³ä»€ä¹ˆï¼‰
                    console.log("Jarvis Thought:", result.thought);

                    // æ‰§è¡Œå›å¤
                    UI.showBubble(result.reply);
                    Voice.speak(result.reply);
                    Visual.setState(result.action || 'speaking');

                } catch (error) {
                    UI.showBubble("Connection Lost. Re-calibrating.");
                    console.error(error);
                } finally {
                    this.isThinking = false;
                    UI.setLoading(false);
                    setTimeout(() => Visual.setState('idle'), 5000);
                }
            }
        };

        /**
         * ğŸ”Š è¯­éŸ³æ¨¡å— (æ›´ç¨³å®šçš„å®ç°)
         */
        const Voice = {
            synth: window.speechSynthesis,
            enabled: true,
            
            speak(text) {
                if (!this.enabled) return;
                this.synth.cancel();
                const utt = new SpeechSynthesisUtterance(text);
                // å°è¯•é€‰ä¸€ä¸ªæ›´åƒ Jarvis çš„å£°éŸ³
                const voices = this.synth.getVoices();
                const zhVoice = voices.find(v => v.lang.includes('zh') && v.name.includes('Google')); // Android/Chrome ä¼˜é€‰
                if (zhVoice) utt.voice = zhVoice;
                
                utt.rate = 1.0;
                utt.pitch = 0.9; // å‹ä½ä¸€ç‚¹
                this.synth.speak(utt);
            }
        };

        /**
         * ğŸ¨ è§†è§‰æ¨¡å— (ç²’å­æ ¸å¿ƒ)
         */
        const Visual = {
            canvas: document.getElementById('main-canvas'),
            ctx: document.getElementById('main-canvas').getContext('2d'),
            particles: [],
            state: 'idle',
            
            init() {
                this.canvas.width = 300; this.canvas.height = 300;
                for(let i=0; i<80; i++) this.particles.push(this.createParticle());
                this.animate();
            },
            
            createParticle() {
                return {
                    angle: Math.random() * Math.PI * 2,
                    radius: 40 + Math.random() * 80,
                    speed: 0.01 + Math.random() * 0.02,
                    size: 1 + Math.random() * 2
                };
            },

            setState(s) { this.state = s; },

            animate() {
                this.ctx.clearRect(0,0,300,300);
                this.ctx.translate(150, 150);
                
                // é¢œè‰²é€»è¾‘
                let color = '#00f2fe'; // idle
                let speedMult = 1;
                if (this.state === 'thinking') { color = '#a29bfe'; speedMult = 5; }
                if (this.state === 'warning') { color = '#ff4757'; speedMult = 2; }

                this.ctx.fillStyle = color;
                this.ctx.strokeStyle = color;

                this.particles.forEach(p => {
                    p.angle += p.speed * speedMult;
                    const x = Math.cos(p.angle) * p.radius;
                    const y = Math.sin(p.angle) * p.radius;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, p.size, 0, Math.PI*2);
                    this.ctx.fill();
                    
                    // è¿çº¿ç‰¹æ•ˆ
                    this.particles.forEach(p2 => {
                        const dx = x - Math.cos(p2.angle)*p2.radius;
                        const dy = y - Math.sin(p2.angle)*p2.radius;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < 40) {
                            this.ctx.globalAlpha = 1 - dist/40;
                            this.ctx.beginPath();
                            this.ctx.moveTo(x, y);
                            this.ctx.lineTo(Math.cos(p2.angle)*p2.radius, Math.sin(p2.angle)*p2.radius);
                            this.ctx.stroke();
                        }
                    });
                });
                
                this.ctx.globalAlpha = 1;
                // ä¸­å¿ƒæ ¸å¿ƒ
                this.ctx.beginPath();
                this.ctx.arc(0,0,30,0,Math.PI*2);
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = color;
                this.ctx.fillStyle = '#fff';
                this.ctx.fill();
                this.ctx.shadowBlur = 0;

                this.ctx.translate(-150, -150);
                requestAnimationFrame(this.animate.bind(this));
            }
        };

        const UI = {
            bubble: document.getElementById('chat-bubble'),
            loader: document.getElementById('loading-ring'),
            
            showBubble(text) {
                this.bubble.innerText = text;
                this.bubble.classList.add('visible');
                // è‡ªåŠ¨éšè—
                clearTimeout(this.timer);
                this.timer = setTimeout(() => this.bubble.classList.remove('visible'), 8000);
            },
            
            setLoading(isLoading) {
                this.loader.style.display = isLoading ? 'block' : 'none';
            }
        };

        // --- å¯åŠ¨åºåˆ— ---
        Sensors.init();
        Visual.init();

        document.getElementById('mic-btn').onclick = () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("System Error: Voice module missing.");
            
            const rec = new SpeechRecognition();
            rec.lang = 'zh-CN';
            rec.onstart = () => { 
                document.getElementById('mic-btn').classList.add('active');
                UI.showBubble("Listening...");
            };
            rec.onend = () => document.getElementById('mic-btn').classList.remove('active');
            rec.onresult = (e) => {
                Brain.process(e.results[0][0].transcript);
            };
            rec.start();
        };
        
        // æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
        document.body.onclick = () => { window.speechSynthesis.speak(new SpeechSynthesisUtterance(" ")); document.body.onclick = null; };

    </script>
</body>
</html>
